<% if (typeof usuario !=='undefined' && usuario && usuario.tipo==0) { %>
    <div id="modal-solicitud-donacion" class="modal" style="display:none;">
        <div class="modal-content">
            <h2><i class="fas fa-seedling"></i> Solicitud de Donaci√≥n Cient√≠fica</h2>
            <div class="alert-info">
                <p><strong>Contribuci√≥n Cient√≠fica:</strong> Tu donaci√≥n ayudar√° a enriquecer nuestro cat√°logo
                    cient√≠fico y promover la investigaci√≥n en plantas medicinales.</p>
            </div>
            <form action="/api/solicitudes" method="post" onsubmit="enviarSolicitudDonacion(event, this)">
                <label>
                    <i class="fas fa-leaf"></i> Nombre com√∫n de la planta:
                    <input type="text" name="nombre_planta" required placeholder="Ej: Manzanilla, Romero, Albahaca...">
                </label>
                <label>
                    <i class="fas fa-file-alt"></i> Descripci√≥n morfol√≥gica:
                    <textarea name="descripcion_planta" required
                        placeholder="Describe las caracter√≠sticas f√≠sicas de la planta (tama√±o, forma de hojas, flores, etc.)..."></textarea>
                </label>
                <label>
                    <i class="fas fa-pills"></i> Propiedades medicinales conocidas:
                    <textarea name="propiedades_medicinales" required
                        placeholder="Describe las propiedades medicinales y usos terap√©uticos documentados..."></textarea>
                </label>
                <label>
                    <i class="fas fa-map-marker-alt"></i> Ubicaci√≥n geogr√°fica:
                    <input type="text" name="ubicacion" required
                        placeholder="Ej: Jard√≠n particular, Parque local, √Årea natural protegida...">
                </label>
                <label>
                    <i class="fas fa-heart"></i> Motivo de la donaci√≥n:
                    <textarea name="motivo_donacion" required
                        placeholder="Explica el prop√≥sito cient√≠fico o educativo de tu donaci√≥n..."></textarea>
                </label>
                <div style="display: flex; gap: 12px; margin-top: 24px; justify-content: center;">
                    <button type="submit"><i class="fas fa-paper-plane"></i> Enviar Solicitud</button>
                    <button type="button"
                        onclick="document.getElementById('modal-solicitud-donacion').style.display='none'"><i
                            class="fas fa-times"></i> Cancelar</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // L√≥gica del modal de donaci√≥n
        document.addEventListener('DOMContentLoaded', function () {
            var btnSolicitud = document.getElementById('btn-solicitud-donacion');
            var modalSolicitud = document.getElementById('modal-solicitud-donacion');

            if (btnSolicitud && modalSolicitud) {
                btnSolicitud.onclick = function (e) {
                    e.preventDefault();
                    modalSolicitud.style.display = 'flex';
                };

                modalSolicitud.onclick = function (e) {
                    if (e.target === this) this.style.display = 'none';
                };
            }
        });

        // Env√≠o AJAX para evitar redirecciones raras si estamos en subp√°ginas
        function enviarSolicitudDonacion(e, form) {
            e.preventDefault();

            const data = Object.fromEntries(new FormData(form).entries());
            data.fecha = new Date().toISOString();
            data.usuario = '<%= usuario.usuario %>'; // Inyectar usuario actual

            // Mapear campos para coincidir con la API si es necesario, o usar el endpoint de vista
            // Usaremos el endpoint API /api/solicitudes creado anteriormente o el de la vista
            // Para mantener consistencia con lo que arreglamos en admin, enviamos JSON

            fetch('/api/solicitudes', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            })
                .then(r => r.json())
                .then(res => {
                    console.log('üìù [DONACION DEBUG] Respuesta del servidor:', res);
                    if (res.id || res.success || res.mensaje) {
                        alert('Solicitud enviada correctamente');
                        document.getElementById('modal-solicitud-donacion').style.display = 'none';
                        form.reset();
                    } else {
                        console.error('‚ùå [DONACION DEBUG] Error:', res);
                        alert('Error: ' + (res.error || 'No se pudo enviar - Respuesta inesperada'));
                    }
                })
                .catch(err => {
                    console.error(err);
                    alert('Error al enviar solicitud');
                });
        }
    </script>
    <% } %>