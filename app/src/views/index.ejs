<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jard칤n de Plantas Medicinales</title>
    <link rel="icon" type="image/png" href="/recursos/imagenes/logo_transparente.png">
    <link rel="stylesheet" href="/recursos/estilos/styles.css?v=<%= Date.now() %>">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>

<body>
    <%- include('partials/header', { usuario, isAuthenticated }) %>

        <main class="contenido-principal">
            <section class="barra-lateral">
                <div class="cientifico-destacado">
                    <h3>Cat치logo Cient칤fico</h3>
                    <p>Explora nuestra colecci칩n de plantas medicinales con informaci칩n cient칤fica detallada.</p>
                </div>

                <form class="busqueda" onsubmit="return false;">
                    <input type="text" placeholder="Buscar planta medicinal..." id="busqueda-input">
                </form>

                <div class="lista-elementos" id="lista-plantas">
                    <% plantas.forEach(function(planta) { %>
                        <div class="elemento planta-item" data-nombre="<%= planta.nombre %>"
                            data-cientifico="<%= planta.nombre_cientifico %>">
                            <div class="imagen-placeholder">
                                <% if(planta.imagen) { %>
                                    <img src="/recursos/imagenes/<%= planta.imagen %>" alt="<%= planta.nombre %>"
                                        style="width:100%;height:100%;object-fit:cover;">
                                    <% } else { %>
                                        游꺔
                                        <% } %>
                            </div>
                            <div class="info-container">
                                <span class="nombre">
                                    <%= planta.nombre %>
                                </span>
                                <% if(planta.nombre_cientifico) { %>
                                    <span class="cientifico">
                                        <%= planta.nombre_cientifico %>
                                    </span>
                                    <% } %>
                            </div>
                            <i class="fas fa-chevron-right" style="margin-left: auto; color: var(--gris-medio);"></i>
                        </div>
                        <% }); %>
                </div>
            </section>

            <section class="descripcion" id="info-planta">
                <div class="descripcion-texto" id="info-planta-content">

                    <% if (plantas && plantas.length> 0) { %>
                        <div class="bienvenida-jardin">
                            <i class="fas fa-leaf"></i>
                            <h3>Jard칤n de Plantas Medicinales</h3>
                            <p>Explora nuestra colecci칩n digital de plantas medicinales. Selecciona una planta del men칰
                                lateral para descubrir sus secretos.</p>

                            <ul class="bienvenida-list">
                                <li>
                                    <i class="fas fa-flask"></i>
                                    <span>Propiedades</span>
                                </li>
                                <li>
                                    <i class="fas fa-mortar-pestle"></i>
                                    <span>Remedios</span>
                                </li>
                                <li>
                                    <i class="fas fa-ban"></i>
                                    <span>Cuidados</span>
                                </li>
                            </ul>
                        </div>
                        <% } else { %>
                            <div class="alert-info">
                                <h3><i class="fas fa-microscope"></i> Informaci칩n Cient칤fica</h3>
                                <p>Selecciona una planta del cat치logo para consultar su informaci칩n.</p>
                            </div>
                            <% } %>

                </div>
            </section>
        </main>

        <%- include('partials/footer') %>

            <%- include('partials/modal-donacion', { usuario: typeof usuario !=='undefined' ? usuario : null }) %>

                <script>
                    // Funci칩n para filtrar plantas
                    function filtrarPlantas() {
                        var busqueda = document.getElementById('busqueda-input').value.toLowerCase();
                        var plantas = document.querySelectorAll('.planta-item');

                        plantas.forEach(function (planta) {
                            var nombre = planta.querySelector('.nombre').textContent.toLowerCase();
                            if (nombre.includes(busqueda)) {
                                planta.style.display = 'flex';
                            } else {
                                planta.style.display = 'none';
                            }
                        });
                    }

                    // B칰squeda en tiempo real
                    document.getElementById('busqueda-input').addEventListener('input', filtrarPlantas);

                    document.querySelectorAll('.planta-item').forEach(function (item) {
                        item.onclick = function () {
                            // Remover selecci칩n previa
                            document.querySelectorAll('.planta-item').forEach(function (el) {
                                el.classList.remove('selected');
                            });

                            // Agregar selecci칩n al elemento actual
                            this.classList.add('selected');

                            // AHORA USAMOS NOMBRE CIENT칈FICO SI EXISTE, SI NO NOMBRE COM칔N (Legacy)
                            var identificador = this.dataset.cientifico || this.dataset.nombre;

                            var xhr = new XMLHttpRequest();
                            // Como cambiamos la ruta a GET /api/plantas/:nombre, el XHR debe cambiar
                            // Antes era POST /plantas/info (que renderizaba el partial).
                            // Wait, index.ejs usa un endpoint de vista (POST /plantas/info) no la API directa para cargar el HTML parcial.
                            // Necesito verificar `plantas.view.routes.js` o donde est칠 definido POST /plantas/info.
                            // Si `index.ejs` hace `xhr.open('POST', '/plantas/info')`, eso no es la API JSON que acabo de cambiar.

                            // Revertimos estrategia moment치neamente:
                            // El usuario pidi칩 cambiar el ENDPOINT DE LA API.
                            // Pero la vista `index.ejs` llama a un endpoint interno para renderizar HTML.
                            // Debo actualizar ESE endpoint tambi칠n para que acepte el nombre cient칤fico.

                            xhr.open('POST', '/plantas/info', true);
                            xhr.setRequestHeader('Content-type', 'application/x-www-form-urlencoded');
                            xhr.onload = function () {
                                document.getElementById('info-planta-content').innerHTML = xhr.responseText;
                                // Reiniciar carrusel al cargar nueva planta
                                setTimeout(initCarousel, 100);
                            };
                            xhr.send('nombre=' + encodeURIComponent(identificador));
                        };
                    });

                    // L칩gica del Carrusel (Global)
                    var slideIndex = 0;

                    function initCarousel() {
                        slideIndex = 0; // Reset
                        showGallerySlide(0);
                    }

                    window.showGallerySlide = function (n) {
                        const slides = document.querySelectorAll('#plantGalleryCarousel .carousel-slide');
                        const dots = document.querySelectorAll('#plantGalleryCarousel .indicator');

                        if (slides.length === 0) return;

                        // Esconder todo
                        slides.forEach(slide => slide.classList.remove('active'));
                        dots.forEach(dot => dot.classList.remove('active'));

                        slideIndex = n;
                        if (slideIndex >= slides.length) slideIndex = 0;
                        if (slideIndex < 0) slideIndex = slides.length - 1;

                        if (slides[slideIndex]) slides[slideIndex].classList.add('active');
                        if (dots[slideIndex]) dots[slideIndex].classList.add('active');
                    }

                    window.moveGallerySlide = function (n) {
                        showGallerySlide(slideIndex + n);
                    }

                    window.currentGallerySlide = function (n) {
                        showGallerySlide(n);
                    }

                    // Funci칩n para alternar pasos de remedios (Global para que funcione con AJAX)
                    window.togglePasos = function (btn) {
                        const container = btn.nextElementSibling;
                        if (container.style.display === 'none') {
                            container.style.display = 'block';
                            btn.innerHTML = '<i class="fas fa-chevron-up"></i> Ocultar Pasos';
                        } else {
                            container.style.display = 'none';
                            btn.innerHTML = '<i class="fas fa-list-ol"></i> Ver Instrucciones de Preparaci칩n';
                        }
                    }

                    /* ===== L칍GICA LIGHTBOX (GALER칈A PANTALLA COMPLETA) ===== */
                    let lightboxImages = [];
                    let lightboxIndex = 0;

                    window.openLightbox = function (index) {
                        // Recolectar im치genes del carrusel actual
                        const slides = document.querySelectorAll('#plantGalleryCarousel .carousel-slide');
                        if (slides.length === 0) return;

                        lightboxImages = Array.from(slides).map(slide => {
                            // Extraer URL del background-image: url("/path/to/img.jpg")
                            const bg = slide.style.backgroundImage;
                            return bg.replace(/^url\(['"]?/, '').replace(/['"]?\)$/, '');
                        });

                        lightboxIndex = index;
                        updateLightboxImage();
                        document.getElementById('lightbox-modal').style.display = 'flex';
                    }

                    window.closeLightbox = function () {
                        document.getElementById('lightbox-modal').style.display = 'none';
                    }

                    window.moveLightboxSlide = function (step) {
                        lightboxIndex += step;
                        if (lightboxIndex >= lightboxImages.length) lightboxIndex = 0;
                        if (lightboxIndex < 0) lightboxIndex = lightboxImages.length - 1;
                        updateLightboxImage();
                    }

                    function updateLightboxImage() {
                        const img = document.getElementById('lightbox-img');
                        const caption = document.getElementById('lightbox-caption');
                        img.src = lightboxImages[lightboxIndex];
                        caption.textContent = `Imagen ${lightboxIndex + 1} de ${lightboxImages.length}`;
                    }

                    // Cerrar con Escape
                    document.addEventListener('keydown', function (e) {
                        if (document.getElementById('lightbox-modal').style.display === 'flex') {
                            if (e.key === 'Escape') closeLightbox();
                            if (e.key === 'ArrowLeft') moveLightboxSlide(-1);
                            if (e.key === 'ArrowRight') moveLightboxSlide(1);
                        }
                    });

                    // DEEP LINKING: Auto-abrir planta desde URL
                    window.addEventListener('load', function() {
                        const urlParams = new URLSearchParams(window.location.search);
                        const plantaParam = urlParams.get('planta');
                        
                        if (plantaParam) {
                            // Buscar por cient칤fico (prioridad) o nombre com칰n
                            // Decodificamos por si acaso, aunque URLSearchParams ya lo hace
                            const target = decodeURIComponent(plantaParam).toLowerCase();
                            
                            const items = document.querySelectorAll('.planta-item');
                            let found = null;
                            
                            for (let item of items) {
                                const cientifico = (item.dataset.cientifico || '').toLowerCase();
                                const nombre = (item.dataset.nombre || '').toLowerCase();
                                
                                if (cientifico === target || nombre === target) {
                                    found = item;
                                    break;
                                }
                            }
                            
                            if (found) {
                                found.click();
                                found.scrollIntoView({ behavior: 'smooth', block: 'center' });
                            }
                        }
                    });
                </script>

                <!-- LIGHTBOX MODAL -->
                <div id="lightbox-modal" class="lightbox">
                    <span class="lightbox-close" onclick="closeLightbox()">&times;</span>
                    <button class="lightbox-btn lightbox-prev" onclick="moveLightboxSlide(-1)">&#10094;</button>
                    <div class="lightbox-content">
                        <img id="lightbox-img" src="" alt="Galer칤a extendida">
                        <div id="lightbox-caption"></div>
                    </div>
                    <button class="lightbox-btn lightbox-next" onclick="moveLightboxSlide(1)">&#10095;</button>
                </div>

</body>

</html>