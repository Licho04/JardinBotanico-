<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Administrador</title>
    <link rel="icon" type="image/png" href="/recursos/imagenes/logo_transparente.png">
    <link rel="stylesheet" href="/recursos/estilos/styles.css?v=<%= Date.now() %>">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>

<body>
    <%- include('../partials/header', { usuario, isAuthenticated: true }) %>

        <main class="admin-dashboard">
            <aside class="admin-sidebar">
                <button class="sidebar-btn <%= vista === 'usuarios' ? 'active' : '' %>" id="btn-usuarios" type="button">
                    <i class="fas fa-users"></i> Administrar usuarios
                </button>
                <button class="sidebar-btn <%= vista === 'plantas' ? 'active' : '' %>" id="btn-plantas" type="button">
                    <i class="fas fa-leaf"></i> Administrar plantas
                </button>
                <button class="sidebar-btn <%= vista === 'solicitudes' ? 'active' : '' %>" id="btn-solicitudes"
                    type="button">
                    <i class="fas fa-seedling"></i> Solicitudes de donación
                </button>
                <button class="sidebar-btn <%= vista === 'usos' ? 'active' : '' %>" id="btn-usos" type="button">
                    <i class="fas fa-tags"></i> Administrar usos
                </button>
            </aside>

            <section class="admin-panel">
                <% if (vista==='usuarios' ) { %>
                    <%- include('partials/tabla-usuarios', { usuarios }) %>
                        <% } else if (vista==='plantas' ) { %>
                            <%- include('partials/tabla-plantas', { plantas }) %>
                                <% } else if (vista==='solicitudes' ) { %>
                                    <%- include('partials/tabla-solicitudes', { solicitudes }) %>
                                        <% } else if (vista==='remedios' ) { %>
                                            <%- include('partials/tabla-remedios', { planta, remedios }) %>
                                                <% } else if (vista==='usos' ) { %>
                                                    <%- include('partials/tabla-usos', { usos }) %>
                                                        <% } %>
            </section>
        </main>

        <!-- Modales -->
        <div id="modal-editar" class="modal" style="display:none;">
            <div class="modal-content" id="modal-content"></div>
        </div>

        <div id="modal-editar-planta" class="modal" style="display:none;">
            <div class="modal-content" id="modal-content-planta"></div>
        </div>

        <div id="modal-responder-solicitud" class="modal" style="display:none;">
            <div class="modal-content" id="modal-content-solicitud"></div>
        </div>

        <div id="modal-ver-donacion" class="modal" style="display:none;">
            <div class="modal-content" style="max-width: 600px; width: 90%;">
                <span class="close"
                    onclick="document.getElementById('modal-ver-donacion').style.display='none'">&times;</span>
                <h2 style="color: var(--verde-oscuro); margin-bottom: 20px;"><i class="fas fa-search-plus"></i> Detalle
                    de Donación</h2>
                <div id="contenido-ver-donacion" style="text-align: left; line-height: 1.6;"></div>
            </div>
        </div>

        <script>
            // Configurar botones de navegación
            document.getElementById('btn-usuarios').onclick = () => window.location = '/administracion/admin?vista=usuarios';
            document.getElementById('btn-plantas').onclick = () => window.location = '/administracion/admin?vista=plantas';
            document.getElementById('btn-solicitudes').onclick = () => window.location = '/administracion/admin?vista=solicitudes';
            document.getElementById('btn-usos').onclick = () => window.location = '/administracion/admin?vista=usos';

            // Funciones para usuarios
            function agregarUsuario() {
                fetch('/administracion/usuarios/agregar')
                    .then(r => r.text())
                    .then(html => {
                        document.getElementById('modal-content').innerHTML = html;
                        document.getElementById('modal-editar').style.display = 'flex';
                    });
            }

            function editarUsuario(usuario) {
                fetch(`/administracion/usuarios/${usuario}/editar`)
                    .then(r => r.text())
                    .then(html => {
                        document.getElementById('modal-content').innerHTML = html;
                        document.getElementById('modal-editar').style.display = 'flex';
                    });
            }

            function eliminarUsuario(usuario) {
                if (!confirm('¿Seguro que deseas eliminar este usuario?')) return;

                fetch(`/administracion/usuarios/${usuario}`, { method: 'DELETE' })
                    .then(r => r.json())
                    .then(data => {
                        if (data.success) {
                            alert('Usuario eliminado');
                            location.reload();
                        } else {
                            alert('Error: ' + (data.error || 'Error desconocido'));
                        }
                    });
            }

            // Funciones para plantas
            function agregarPlanta() {
                fetch('/administracion/plantas/agregar')
                    .then(r => r.text())
                    .then(html => {
                        document.getElementById('modal-content-planta').innerHTML = html;
                        document.getElementById('modal-editar-planta').style.display = 'flex';
                    });
            }

            function editarPlanta(id) {
                fetch(`/administracion/plantas/${id}/editar`)
                    .then(r => r.text())
                    .then(html => {
                        document.getElementById('modal-content-planta').innerHTML = html;
                        document.getElementById('modal-editar-planta').style.display = 'flex';
                    });
            }

            function eliminarPlanta(id) {
                if (!confirm('¿Seguro que deseas eliminar esta planta?')) return;

                fetch(`/administracion/plantas/${id}`, { method: 'DELETE' })
                    .then(r => r.json())
                    .then(data => {
                        if (data.success) {
                            alert('Planta eliminada');
                            location.reload();
                        } else {
                            console.error('Delete failed:', data);
                            alert('Error: ' + (data.error || 'Error desconocido'));
                        }
                    })
                    .catch(err => {
                        console.error('Delete fetch error:', err);
                        alert('Error de conexión o respuesta inválida');
                    });
            }

            // Funciones para solicitudes
            // Funciones para solicitudes
            function verDetallesDonacion(solicitudStr) {
                try {
                    const solicitud = JSON.parse(solicitudStr);
                    const html = `
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                            <p><strong><i class="fas fa-user"></i> Usuario:</strong> ${solicitud.usuario || solicitud.correo_usuario}</p>
                            <p><strong><i class="fas fa-calendar"></i> Fecha:</strong> ${new Date(solicitud.fecha || solicitud.fecha_donacion).toLocaleDateString()}</p>
                            <p><strong><i class="fas fa-leaf"></i> Planta:</strong> ${solicitud.nombre_comun || solicitud.nombre_planta}</p>
                            <p><strong><i class="fas fa-map-marker-alt"></i> Distribución:</strong> ${solicitud.distribucion_geografica || solicitud.ubicacion || 'No especificada'}</p>
                        </div>

                        <h3 style="font-size: 1.1rem; color: #4b6e3c; margin-top: 15px;">Descripción</h3>
                        <p style="background: white; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
                            ${solicitud.descripcion || solicitud.descripcion_planta || 'Sin descripción'}
                        </p>

                        <h3 style="font-size: 1.1rem; color: #4b6e3c; margin-top: 15px;">Propiedades Curativas</h3>
                        <p style="background: white; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
                            ${solicitud.propiedades_curativas || solicitud.propiedades_medicinales || 'No especificadas'}
                        </p>

                        <h3 style="font-size: 1.1rem; color: #4b6e3c; margin-top: 15px;">Motivo de Donación</h3>
                        <p style="background: white; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
                            ${solicitud.motivo_donacion || 'No especificado'}
                        </p>

                        <div style="text-align: center; margin-top: 20px;">
                            <button onclick="document.getElementById('modal-ver-donacion').style.display='none'" 
                                style="background: #666; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer;">
                                Cerrar
                            </button>
                        </div>
                    `;
                    document.getElementById('contenido-ver-donacion').innerHTML = html;
                    document.getElementById('modal-ver-donacion').style.display = 'flex';
                } catch (e) {
                    console.error('Error parsing JSON', e);
                    alert('Error al cargar detalles');
                }
            }

            function enviarRespuesta(e, id) {
                e.preventDefault();
                const form = e.target;

                const data = Object.fromEntries(new FormData(form).entries());

                fetch(`/administracion/solicitudes/${id}/actualizar`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                })
                    .then(r => r.json())
                    .then(res => {
                        if (res.success) {
                            alert('Respuesta guardada');
                            location.reload();
                        } else {
                            alert('Error: ' + (res.error || 'Error desconocido'));
                        }
                    })
                    .catch(err => {
                        console.error('Error:', err);
                        alert('Error de conexión');
                    });
            }

            function responderSolicitud(id) {
                fetch(`/administracion/solicitudes/${id}/responder`)
                    .then(r => r.text())
                    .then(html => {
                        document.getElementById('modal-content-solicitud').innerHTML = html;
                        document.getElementById('modal-responder-solicitud').style.display = 'flex';
                    });
            }

            function eliminarSolicitud(id) {
                if (!confirm('¿Seguro que deseas eliminar esta solicitud?')) return;

                fetch(`/api/solicitudes/${id}`, { method: 'DELETE' }) // Usar API endpoint correcto
                    .then(r => r.json())
                    .then(data => {
                        if (data.success || data.mensaje) {
                            alert('Solicitud eliminada');
                            location.reload();
                        } else {
                            alert('Error: ' + (data.error || 'Error desconocido'));
                        }
                    });
            }

            // Funciones para Usos
            function agregarUso() {
                fetch('/administracion/usos/agregar')
                    .then(r => r.text())
                    .then(html => {
                        document.getElementById('modal-content').innerHTML = html;
                        document.getElementById('modal-editar').style.display = 'flex';
                    });
            }

            function editarUso(id) {
                console.log('Clicked editarUso with ID:', id);
                fetch(`/administracion/usos/${id}/editar`)
                    .then(r => {
                        console.log('Fetch response status:', r.status);
                        return r.text();
                    })
                    .then(html => {
                        console.log('Modal content received');
                        document.getElementById('modal-content').innerHTML = html;
                        document.getElementById('modal-editar').style.display = 'flex';
                    })
                    .catch(err => console.error('Error fetching edit form:', err));
            }

            function eliminarUso(id) {
                if (!confirm('¿Estás seguro de eliminar este uso? Esto podría afectar a las plantas que lo tengan asignado.')) return;

                fetch(`/api/usos/${id}`, { method: 'DELETE' })
                    .then(r => r.json())
                    .then(data => {
                        if (data.success) {
                            alert('Uso eliminado correctamente');
                            location.reload();
                        } else {
                            alert('Error al eliminar: ' + (data.error || 'Desconocido'));
                        }
                    })
                    .catch(err => {
                        console.error(err);
                        alert('Error al eliminar uso');
                    });
            }

            // Funciones para Remedios
            function agregarRemedio(plantaId) {
                fetch(`/administracion/remedios/agregar?planta_id=${plantaId}`)
                    .then(r => r.text())
                    .then(html => {
                        document.getElementById('modal-content-planta').innerHTML = html;
                        document.getElementById('modal-editar-planta').style.display = 'flex';
                    });
            }

            function editarRemedio(id) {
                fetch(`/administracion/remedios/${id}/editar`)
                    .then(r => r.text())
                    .then(html => {
                        document.getElementById('modal-content-planta').innerHTML = html;
                        document.getElementById('modal-editar-planta').style.display = 'flex';
                    });
            }

            function eliminarRemedio(id) {
                if (!confirm('¿Seguro que deseas eliminar este remedio?')) return;

                fetch(`/api/remedios/${id}`, { method: 'DELETE' })
                    .then(r => r.json())
                    .then(data => {
                        // La API puede retornar success: true o id eliminado
                        if (data.success || data.id) {
                            alert('Remedio eliminado correctamente');
                            location.reload();
                        } else {
                            alert('Error: ' + (data.error || 'Error desconocido'));
                        }
                    })
                    .catch(err => {
                        console.error(err);
                        alert('Error de conexión');
                    });
            }

            // Funciones Globales para Galería (Plantas)
            // Se mueven aquí porque al cargar el formulario vía AJAX, los scripts internos no se ejecutan
            window.eliminarImagen = function (btn) {
                if (confirm('¿Quitar esta imagen de la galería? (Se aplicará al guardar)')) {
                    const item = btn.closest('.gallery-item');
                    if (item) item.remove();
                }
            };

            window.moverImagen = function (btn, direction) {
                const item = btn.closest('.gallery-item');
                const container = item.parentElement;
                if (direction === -1 && item.previousElementSibling) {
                    container.insertBefore(item, item.previousElementSibling);
                } else if (direction === 1 && item.nextElementSibling) {
                    container.insertBefore(item.nextElementSibling, item);
                }
            };

            // --- LÓGICA DE REMEDIOS (Globalizada) ---
            window.agregarPasoInput = function () {
                const container = document.getElementById('lista-pasos');
                const count = container.querySelectorAll('.paso-item').length;
                const div = document.createElement('div');
                div.className = 'paso-item';
                div.style = "display: flex; gap: 10px; margin-bottom: 10px; align-items: center;";
                div.innerHTML = `
                    <span class="paso-num" style="font-weight: bold; width: 25px; text-align: center; background: #e2e8f0; border-radius: 50%; height: 25px; display: flex; align-items: center; justify-content: center; font-size: 0.8rem;">${count + 1}</span>
                    <input type="text" name="pasos_desc[]" required style="flex: 1; padding: 12px 16px; border: 2px solid #e0e0e0; border-radius: 12px; background: #f5f5f5;" placeholder="Descripción del paso">
                    <button type="button" onclick="eliminarPaso(this)" style="background: #dc2626; color: white; padding: 5px 10px; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center;">
                        <i class="fas fa-times"></i>
                    </button>
                `;
                container.appendChild(div);
                actualizarNumerosPasos();
            };

            window.eliminarPaso = function (btn) {
                const item = btn.closest('.paso-item');
                const container = document.getElementById('lista-pasos');
                if (container.querySelectorAll('.paso-item').length > 1) {
                    item.remove();
                    actualizarNumerosPasos();
                } else {
                    // Si es el único, solo limpiar valor
                    item.querySelector('input').value = '';
                }
            };

            window.actualizarNumerosPasos = function () {
                const pasos = document.querySelectorAll('.paso-item .paso-num');
                pasos.forEach((span, index) => {
                    span.textContent = index + 1;
                });
            };

            window.submitRemedio = async function (e, url, method) {
                e.preventDefault();
                const form = e.target;
                const formData = new FormData(form);

                // Objeto base
                const obj = {
                    pasos: [],
                    usos: []
                };

                // Recolectar campos de texto simples
                const simpleFields = [
                    'nombre', 'descripcion', 'parte', 'formato',
                    'dosis_cantidad', 'dosis_unidad', 'tiempo_efectividad',
                    'nombre_cientifico', 'contraindicaciones', 'efectos_secundarios'
                ];

                simpleFields.forEach(field => {
                    if (formData.has(field)) obj[field] = formData.get(field);
                });

                // Checkbox booleano
                obj.checar_medico = formData.get('checar_medico') === 'on';

                // Checkboxes múltiples (Usos)
                const usosChecked = form.querySelectorAll('input[name="usos"]:checked');
                usosChecked.forEach(cb => obj.usos.push(cb.value));

                // Pasos (recolectar todos los inputs 'pasos_desc[]' en orden)
                const pasosInputs = form.querySelectorAll('input[name="pasos_desc[]"]');
                pasosInputs.forEach((input, index) => {
                    if (input.value.trim()) {
                        obj.pasos.push({
                            num_paso: index + 1,
                            descripcion: input.value.trim()
                        });
                    }
                });

                try {
                    const res = await fetch(url, {
                        method: method,
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(obj)
                    });

                    const data = await res.json();

                    if (res.ok) {
                        alert('Remedio guardado exitosamente');
                        location.reload();
                    } else {
                        console.error('❌ Error serv:', data);
                        alert('Error al guardar: ' + (data.error || 'Error desconocido'));
                    }
                } catch (err) {
                    console.error('❌ Error red:', err);
                    alert('Error de conexión: ' + err.message);
                }
            };


            // Cerrar modales al hacer clic fuera
            // Cerrar modales al hacer clic fuera - DESHABILITADO PARA PREVENIR PÉRDIDA DE DATOS
            /*
            document.getElementById('modal-editar').onclick = function (e) {
                if (e.target === this) this.style.display = 'none';
            };
            document.getElementById('modal-editar-planta').onclick = function (e) {
                if (e.target === this) this.style.display = 'none';
            };
            document.getElementById('modal-responder-solicitud').onclick = function (e) {
                if (e.target === this) this.style.display = 'none';
            };
            document.getElementById('modal-ver-donacion').onclick = function (e) {
                if (e.target === this) this.style.display = 'none';
            };
            */

            // Manejar envío de formularios
            document.addEventListener('submit', function (e) {
                const form = e.target;
                // Usar getAttribute porque si hay un input name="id", form.id devuelve ese input
                const formId = form.getAttribute('id');
                console.log('Submit detected from form ID:', formId);

                if (['form-usuario', 'form-planta', 'form-uso'].includes(formId)) {
                    e.preventDefault();
                    console.log('Prevented default submit for:', formId);

                    // Lógica específica para form-uso (API REST)
                    // Este bloque maneja tanto Agregar (POST) como Editar (PUT)
                    if (formId === 'form-uso') {
                        const idInput = document.getElementById('id_uso');
                        const id = idInput ? idInput.value : null;

                        // Si existe ID es edición (PUT), si no es creación (POST)
                        const url = id ? `/api/usos/${id}` : '/api/usos';
                        const method = id ? 'PUT' : 'POST';

                        console.log(`[Form-Uso] Submitting to ${url} with method ${method}`);

                        // Convertir FormData a JSON
                        const formData = new FormData(form);
                        const data = Object.fromEntries(formData.entries());

                        fetch(url, {
                            method: method,
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(data)
                        })
                            .then(r => r.json())
                            .then(resp => {
                                if (resp.id || resp.success) {
                                    alert('Guardado exitosamente');
                                    location.reload();
                                } else {
                                    alert('Error: ' + (resp.error || 'Error desconocido'));
                                }
                            })
                            .catch(err => {
                                console.error(err);
                                alert('Error de conexión');
                            });
                        return; // IMPORTANTE: Detenemos aquí para que no siga procesando
                    }

                    // Lógica para otros formularios (Views/Existing Logic)
                    const url = form.action;
                    let options = { method: 'POST' };

                    if (form.id === 'form-planta') {
                        options.body = new FormData(form);
                    } else {
                        const formData = new FormData(form);
                        const data = Object.fromEntries(formData.entries());
                        options.headers = { 'Content-Type': 'application/json' };
                        options.body = JSON.stringify(data);
                    }

                    fetch(url, options)
                        .then(r => r.json())
                        .then(data => {
                            if (data.success) {
                                alert(data.mensaje || 'Operación exitosa');
                                location.reload();
                            } else {
                                alert('Error: ' + (data.error || 'Error desconocido'));
                            }
                        })
                        .catch(err => {
                            console.error('SERVER ERROR:', err);
                            alert('Error técnico: ' + (err.message || err));
                        });
                }
            });
        </script>
        <!-- MODAL QR -->
        <div id="modal-qr" class="modal" style="display:none;">
            <div class="modal-content" style="max-width: 400px; text-align: center;">
                <span class="close" onclick="document.getElementById('modal-qr').style.display='none'">&times;</span>
                <h3>Código QR</h3>
                <p id="qr-plant-name" style="font-weight: bold; margin-bottom: 1rem;"></p>
                <div id="qr-code-container"
                    style="display: flex; justify-content: center; align-items: center; margin: 20px auto; width: 100%;">
                </div>
                <p style="font-size: 0.9em; color: #666; word-break: break-all;" id="qr-url-text"></p>
                <button onclick="imprimirQR()" class="btn-formulario" style="margin-top: 15px;">
                    <i class="fas fa-print"></i> Imprimir
                </button>
            </div>
        </div>

        <!-- Librería QR Code (usando CDN confiable) -->
        <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

        <script>
            // ... (Scripts existentes) ...

            // Lógica QR
            let qrCodeObj = null;

            function generarQR(nombreCientifico, nombreComun) {
                const modal = document.getElementById('modal-qr');
                const container = document.getElementById('qr-code-container');
                const nameLabel = document.getElementById('qr-plant-name');
                const urlLabel = document.getElementById('qr-url-text');

                // Limpiar previo
                container.innerHTML = '';

                // Construir URL Deep Link
                // Usamos window.location.origin para obtener el dominio actual (localhost o render)
                // Asumimos que la ruta pública es la raíz '/'
                // Ajustar si el proyecto está en subruta, pero generalmente es root.
                const baseUrl = window.location.origin;
                const deepLink = `${baseUrl}/?planta=${encodeURIComponent(nombreCientifico)}`;

                console.log('Generando QR para:', deepLink);

                nameLabel.textContent = `${nombreComun} (${nombreCientifico})`;
                urlLabel.textContent = deepLink;

                // Generar QR
                try {
                    qrCodeObj = new QRCode(container, {
                        text: deepLink,
                        width: 256,
                        height: 256,
                        colorDark: "#000000",
                        colorLight: "#ffffff",
                        correctLevel: QRCode.CorrectLevel.H
                    });

                    modal.style.display = 'block';
                } catch (e) {
                    console.error('Error generando QR:', e);
                    alert('Error al generar el código QR. Verifique conexión a internet para cargar la librería.');
                }
            }

            function imprimirQR() {
                const contenido = document.getElementById('qr-code-container').innerHTML;
                const titulo = document.getElementById('qr-plant-name').textContent;

                const ventana = window.open('', '', 'height=600,width=800');
                ventana.document.write('<html><head><title>Imprimir QR</title>');
                ventana.document.write('<style>body{font-family: sans-serif; text-align: center; padding: 50px;}</style>');
                ventana.document.write('</head><body>');
                ventana.document.write(`<h2>${titulo}</h2>`);
                ventana.document.write(contenido);
                ventana.document.write('<p>Escanea para ver información detallada</p>');
                ventana.document.write('</body></html>');
                ventana.document.close();
                ventana.print();
            }
        </script>
</body>

</html>