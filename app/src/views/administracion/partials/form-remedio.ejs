<% /* Lógica de inicialización */ const isEdit=(typeof remedio !=='undefined' && remedio !==null); const
    urlAction=isEdit ? '/api/remedios/' + remedio.id : '/api/remedios' ; const method=isEdit ? 'PUT' : 'POST' ; const
    titulo=isEdit ? 'Editar Remedio' : 'Nuevo Remedio' ; /* Pre-calcular valores complejos */ let contraVal='' ; if
    (isEdit && remedio.contraindicaciones) { if (Array.isArray(remedio.contraindicaciones)) {
    contraVal=remedio.contraindicaciones.map(c=> c.descripcion).join(', ');
    } else {
    contraVal = remedio.contraindicaciones;
    }
    }

    let efectosVal = '';
    if (isEdit && remedio.efectos_secundarios) {
    if (Array.isArray(remedio.efectos_secundarios)) {
    efectosVal = remedio.efectos_secundarios.map(e => e.descripcion).join(', ');
    } else {
    efectosVal = remedio.efectos_secundarios;
    }
    }
    %>

    <h2>
        <%= titulo %>
    </h2>

    <% if (typeof plantaNombreCientifico !=='undefined' && plantaNombreCientifico) { %>
        <p style="margin-bottom: 20px; color: #555;">
            <i class="fas fa-leaf"></i> Planta: <strong>
                <%= plantaNombreCientifico %>
            </strong>
        </p>
        <% } %>

            <form id="form-remedio" onsubmit="submitRemedio(event, '<%= urlAction %>', '<%= method %>')">

                <% if (!isEdit && typeof plantaNombreCientifico !=='undefined' ) { %>
                    <input type="hidden" name="nombre_cientifico" value="<%= plantaNombreCientifico %>">
                    <% } %>

                        <label>
                            Nombre del Remedio:
                            <input type="text" name="nombre" value="<%= isEdit ? remedio.nombre : '' %>" required
                                placeholder="Ej: Té para la tos">
                        </label>

                        <label>
                            Descripción:
                            <textarea name="descripcion" required
                                rows="3"><%= isEdit ? remedio.descripcion : '' %></textarea>
                        </label>

                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                            <label>
                                Parte Utilizada:
                                <input type="text" name="parte" value="<%= isEdit ? remedio.parte : '' %>">
                            </label>
                            <label>
                                Formato:
                                <input type="text" name="formato" value="<%= isEdit ? remedio.formato : '' %>"
                                    placeholder="Ej: Infusión">
                            </label>
                        </div>

                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                            <label>
                                Dosis (Cantidad):
                                <input type="number" step="0.1" name="dosis_cantidad"
                                    value="<%= isEdit ? remedio.dosis_cantidad : '' %>">
                            </label>
                            <label>
                                Unidad:
                                <input type="text" name="dosis_unidad" value="<%= isEdit ? remedio.dosis_unidad : '' %>"
                                    placeholder="mg, ml, tazas">
                            </label>
                        </div>

                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                            <label>
                                Tiempo Efectividad:
                                <input type="text" name="tiempo_efectividad"
                                    value="<%= isEdit ? remedio.tiempo_efectividad : '' %>">
                            </label>
                            <div style="display: flex; align-items: center; padding-top: 25px;">
                                <label
                                    style="display: flex; flex-direction: row; align-items: center; gap: 10px; cursor: pointer;">
                                    <input type="checkbox" name="checar_medico" <%=(!isEdit || remedio.checar_medico)
                                        ? 'checked' : '' %> style="width: auto;">
                                    Consultar al médico
                                </label>
                            </div>
                        </div>

                        <label>
                            Usos (Aplicaciones):
                            <div
                                style="display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 8px; border: 2px solid #e0e0e0; padding: 10px; border-radius: 12px; max-height: 150px; overflow-y: auto; background: #f5f5f5; margin-top: 5px;">
                                <% if (typeof usos !=='undefined' && usos.length> 0) { %>
                                    <% usos.forEach(uso=> {
                                        const isChecked = (isEdit && remedio.usosIds &&
                                        remedio.usosIds.includes(uso.id));
                                        %>
                                        <label
                                            style="display: flex; flex-direction: row; align-items: center; gap: 5px; font-weight: normal; font-size: 0.9rem; margin: 0;">
                                            <input type="checkbox" name="usos" value="<%= uso.id %>"
                                                style="width: auto;" <%=isChecked ? 'checked' : '' %>>
                                            <%= uso.nombre %>
                                        </label>
                                        <% }); %>
                                            <% } else { %>
                                                <p style="color: #666; font-style: italic;">No hay usos registrados.</p>
                                                <% } %>
                            </div>
                        </label>

                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                            <label>
                                Contraindicaciones: <small>(Separar por comas)</small>
                                <textarea name="contraindicaciones"><%= contraVal %></textarea>
                            </label>
                            <label>
                                Efectos Secundarios: <small>(Separar por comas)</small>
                                <textarea name="efectos_secundarios"><%= efectosVal %></textarea>
                            </label>
                        </div>

                        <div class="pasos-section"
                            style="margin-top: 20px; border-top: 2px solid #eee; padding-top: 15px;">
                            <div
                                style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                <h3 style="margin: 0; color: #2e7d32; font-size: 1.1rem;">Pasos de Preparación</h3>
                                <button type="button" onclick="agregarPasoInput()"
                                    style="padding: 5px 10px; font-size: 0.9rem;">
                                    <i class="fas fa-plus"></i> Agregar
                                </button>
                            </div>
                            <div id="lista-pasos">
                                <% if (isEdit && remedio.pasos && remedio.pasos.length> 0) { %>
                                    <% remedio.pasos.forEach((paso, index)=> { %>
                                        <div class="paso-item"
                                            style="display: flex; gap: 10px; margin-bottom: 10px; align-items: center;">
                                            <span class="paso-num"
                                                style="font-weight: bold; width: 25px; text-align: center; background: #e2e8f0; border-radius: 50%; height: 25px; display: flex; align-items: center; justify-content: center; font-size: 0.8rem;">
                                                <%= index + 1 %>
                                            </span>
                                            <input type="text" name="pasos_desc[]" value="<%= paso.descripcion %>"
                                                style="flex: 1; padding: 12px 16px; border: 2px solid #e0e0e0; border-radius: 12px; background: #f5f5f5;"
                                                required>
                                            <button type="button" onclick="eliminarPaso(this)"
                                                style="background: #dc2626; color: white; padding: 5px 10px; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center;">
                                                <i class="fas fa-times"></i>
                                            </button>
                                        </div>
                                        <% }); %>
                                            <% } else { %>
                                                <!-- Paso 1 por defecto -->
                                                <div class="paso-item"
                                                    style="display: flex; gap: 10px; margin-bottom: 10px; align-items: center;">
                                                    <span class="paso-num"
                                                        style="font-weight: bold; width: 25px; text-align: center; background: #e2e8f0; border-radius: 50%; height: 25px; display: flex; align-items: center; justify-content: center; font-size: 0.8rem;">1</span>
                                                    <input type="text" name="pasos_desc[]"
                                                        style="flex: 1; padding: 12px 16px; border: 2px solid #e0e0e0; border-radius: 12px; background: #f5f5f5;"
                                                        placeholder="Describe el primer paso..." required>
                                                    <button type="button" onclick="eliminarPaso(this)"
                                                        style="background: #dc2626; color: white; padding: 5px 10px; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center;"
                                                        disabled>
                                                        <i class="fas fa-times"></i>
                                                    </button>
                                                </div>
                                                <% } %>
                            </div>
                        </div>

                        <div style="display: flex; gap: 12px; margin-top: 24px; justify-content: center;">
                            <button type="submit">
                                <i class="fas fa-save"></i>
                                <%= isEdit ? 'Actualizar' : 'Guardar' %>
                            </button>
                            <button type="button"
                                onclick="document.getElementById('modal-editar-planta').style.display='none'"
                                style="background: #757575;">
                                <i class="fas fa-times"></i> Cancelar
                            </button>
                        </div>
            </form>

            <!-- Script movido a admin.ejs para funcionar con AJAX -->